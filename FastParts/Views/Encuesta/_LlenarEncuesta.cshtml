
@model FastParts.Models.EncuestaViewModel


<div class="container mt-4">


        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-3">@Model.Encuesta.Nombre</h5>
                <div class="col-sm-8">@Model.Encuesta.Descripcion</div>
            </div>
            <div class="card-body">

                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <tbody>
                            @foreach (var pregunta in Model.Encuesta.Preguntas)
                            {
                                <tr>
                                    @using (Html.BeginForm(
                                        "RespoderPregunta",
                                        "Encuesta",
                                        new {
                                            ID_Encuesta = @Model.Encuesta.ID_Encuesta,
                                            Session_Id = @Model.Session_Id,
                                            ID_Pregunta = @pregunta.ID_Pregunta,
                                            Tipo = @pregunta.Tipo
      
                                        },
                                        FormMethod.Post,
                                        new
                                        {
                                            id = $"formPregunta_{pregunta.ID_Pregunta}",
                                            enctype = "multipart/form-data"
                                        }
                                    )) {
                                        <div class="encuesta-title">
                                            <label class="form-label fw-bold">@pregunta.Descripcion</label>
                                        </div>

                                        <div class="encuesta-body">
                                            <div class="mb-4 p-3 border rounded shadow-sm">
                                                @{
                                                    string inputName = $"Respuesta_{pregunta.ID_Pregunta}";
                                                    string formId = $"formPregunta_{pregunta.ID_Pregunta}";
                                                }

                                                @switch (pregunta.Tipo)
                                                {
                                                    case "Rango":
                                                        // Tipo: Rango (Input Type Range)
                                                        <div class="mt-2">
                                                            @Html.TextBoxFor(model => pregunta.ValorRespuesta, new
                                                            {
                                                               @type = "range",
                                                               @name = inputName,
                                                               @class = "form-range",
                                                               min = pregunta.Minimo ?? 0,
                                                               max = pregunta.Maximo ?? 10,
                                                               value = pregunta.ValorRespuesta,
                                                               onchange = $"document.getElementById('{formId}').submit();"
                                                           })
                                                            <small class="text-muted"><span id="valor-@inputName">@pregunta.ValorRespuesta</span></small>
                                                        </div>
                                                        break;

                                                    case "Texto":
                                                        // Tipo: Texto (Textarea para respuestas largas)
                                                        <div class="mt-2">
                                                            @Html.TextAreaFor(model => pregunta.TextoRespuesta, new
                                                            {
                                                               @class = "form-control",
                                                               rows = "3",
                                                               onchange = $"document.getElementById('{formId}').submit();"
                                                           })
                                                        </div>
                                                        break;

                                                    case "OpcionMultiple":
                                                        // Tipo: Opción Múltiple (Dropdown/Select con múltiples opciones)
                                                        <div class="mt-2">
                                                            <select name="TextoRespuesta"
                                                                    class="form-select"
                                                                    onchange="document.getElementById('@formId').submit();">
                                                                @foreach (var opcion in (pregunta.Opciones ?? "").Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries))
                                                                {
                                                                    var opcionTrimmed = opcion.Trim();
                                                                    var isSelected = pregunta.TextoRespuesta != null && pregunta.TextoRespuesta.Contains(opcionTrimmed);

                                                                    <option value="@opcionTrimmed"
                                                                            @(isSelected ? "selected" : "")>
                                                                        @opcionTrimmed
                                                                    </option>
                                                                }
                                                            </select>
                                                        </div>
                                                        break;

                                                    case "CasillasVerificacion":
                                                        // Tipo: Casillas de Verificación (Checkboxes)
                                                        <div class="mt-2">
                                                            @{
                                                                var opcionesSplit = (pregunta.Opciones ?? "").Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);
                                                                var opcionesConIndice = opcionesSplit.Select((opcion, i) => new { Opcion = opcion, Index = i });
                                                            }

                                                            @foreach (var @item in opcionesConIndice)
                                                            {
                                                                var opcionTrimmed = @item.Opcion.Trim();
                                                                var isChecked = pregunta.TextoRespuesta != null && pregunta.TextoRespuesta.Contains(opcionTrimmed);
                                                                string checkboxName = $"{inputName}-{item.Index}";

                                                                <div class="form-check">
                                                                    <input class="form-check-input"
                                                                           type="checkbox"
                                                                           name="@checkboxName"
                                                                           value="@opcionTrimmed"
                                                                           @(isChecked ? "checked" : "")
                                                                           onchange="document.getElementById('@formId').submit();">
                                                                    <label class="form-check-label" for="@checkboxName">
                                                                        @opcionTrimmed
                                                                    </label>
                                                                </div>
                                                            }
                                                        </div>
                                                        break;

                                                    case "Imagen":
                                                        // Tipo: Imagen (Input File con vista previa)
                                                        <div class="mt-3">
                                                            <input type="hidden"
                                                                   id="hidden-@pregunta.ID_Pregunta"
                                                                   name="TextoRespuesta"
                                                                   value="" />
                                                            <input type="file"
                                                                   name="@inputName"
                                                                   accept="image/png, image/jpeg, image/gif, image/webp"
                                                                   class="form-control"
                                                                   onchange="(async () => {
                                                                                    console.log('Daniel');
                                                                                    var p = document.getElementById('preview-@pregunta.ID_Pregunta');
                                                                                    var s = document.getElementById('submit-@pregunta.ID_Pregunta');
                                                                                    var f = document.getElementById('formPregunta_@pregunta.ID_Pregunta');
                                                                                    var hiddenInput = document.getElementById('hidden-@pregunta.ID_Pregunta');
                                                                                    var img = this.files[0];
                                                                                    p.src = window.URL.createObjectURL(img);
                                                                                    p.style.display = 'block';
                                                                                    s.style.display = 'block';
                                                                                    var reader = new FileReader();

                                                                                    reader.onload = function (e) {
                                                                                        var base64Data = e.target.result;
                                                                                        hiddenInput.value = base64Data; 
                                                                                        // Si desea enviar automáticamente:
                                                                                        // f.submit();
                                                                                    };

                                                                                    reader.onerror = function (error) {
                                                                                        console.error('Error al leer el archivo:', error);
                                                                                        alert('Hubo un error al cargar la imagen. Inténtelo de nuevo.');
                                                                                    };

                                                                                    // Iniciar la lectura del archivo. Esto dispara el evento 'onload'.
                                                                                    reader.readAsDataURL(img);
                                                                                })();" />

                                                            <div class="form-text text-muted mb-2" style="font-size: 0.8rem;">
                                                                Formatos: JPG, PNG. Máx 10MB.
                                                            </div>

                                                            <div class="text-center p-2 border rounded bg-light mt-2 position-relative" style="min-height: 60px;">
                                                                @{
                                                                    var hasSrc = pregunta.TextoRespuesta != null ? "block" : "none";
                                                                }
                                                                <img id="preview-@pregunta.ID_Pregunta"
                                                                     src="@pregunta.TextoRespuesta"
                                                                     alt="Vista previa"
                                                                     style="display: @hasSrc; max-width: 100%; max-height: 200px; object-fit: contain; margin: 0 auto;" />
                                                            </div>
                                                            <div id="submit-@pregunta.ID_Pregunta" class="mt-2 gap-2" style="display: @hasSrc;">
                                                                <button type="submit" class="btn btn-primary btn-sm">
                                                                    <i class="fa fa-upload"></i> Guardar Imagen
                                                                </button>
                                                            </div>
                                                        </div>
                                                        break;


                                                    default: break;
                                                }
                                            </div>
                                        </div>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

            </div>
        </div>

        
</div>