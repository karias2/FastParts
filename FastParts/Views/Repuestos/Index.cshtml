@model IEnumerable<FastParts.Models.RepuestoModel>
@{
    var placeholder = Url.Content("~/Content/img/placeholder-part.png");
}
<h2>Repuestos</h2>

<div class="repuestos-toolbar">
    <div>
        @Html.ActionLink("Crear repuesto", "Create", "Repuestos", null, new { @class = "btn btn-primary" })
    </div>

    <div class="repuestos-search">
        <input type="text" id="searchText" class="form-control" placeholder="Buscar repuestos..." />
        <button type="button" id="searchBtn" class="btn btn-default">Buscar</button>
    </div>
</div>

<div class="cards" id="cards">
    @foreach (var x in Model)
    {
        <article class="card" data-nombre="@x.Nombre" data-marca="@x.Marca">
            <div class="img-wrap">
                <img src="@Url.Content(string.IsNullOrWhiteSpace(x.ImagenUrl) ? placeholder : x.ImagenUrl)"
                     alt="@x.Nombre" />
            </div>

            <h4>@x.Nombre</h4>

            <div class="meta">
                <span>@x.Marca</span>
                <strong>@x.Precio.ToString("C", new System.Globalization.CultureInfo("es-CR"))</strong>
            </div>

            <div class="badges">
                @if (x.SinStockForzado)
                {<span class="badge badge-danger">SIN STOCK (forzado)</span> }
                else if (x.Stock <= x.StockMinimo)
                { <span class="badge badge-warning">Bajo mínimo (@x.Stock/@x.StockMinimo)</span> }
            else
            { <span class="badge badge-ok">En stock: @x.Stock</span>}

                @if (x.OcultarClientes)
                {<span class="badge badge-muted">Oculto a clientes</span>}
            </div>

            <div class="actions">
                @Html.ActionLink("Ver detalles", "Details", "Repuestos", new { id = x.Id }, new { @class = "btn btn-sm btn-default" })
                @Html.ActionLink("Editar", "Edit", "Repuestos", new { id = x.Id }, new { @class = "btn btn-sm btn-warning" })
                @Html.ActionLink("Eliminar", "Delete", "Repuestos", new { id = x.Id }, new { @class = "btn btn-sm btn-danger" })
            </div>

            <div class="admin-actions">
                @using (Html.BeginForm("ToggleOcultar", "Repuestos", FormMethod.Post, new { @class = "inline" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.Hidden("id", x.Id)
                    <button type="submit" class="btn btn-xs @(x.OcultarClientes ? "btn-warning" : "btn-default")">
                        @(x.OcultarClientes ? "Mostrar" : "Ocultar")
                    </button>
                }
                @using (Html.BeginForm("ToggleForzarSinStock", "Repuestos", FormMethod.Post, new { @class = "inline", style = "margin-left:4px" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.Hidden("id", x.Id)
                    <button type="submit" class="btn btn-xs @(x.SinStockForzado ? "btn-danger" : "btn-default")">
                        @(x.SinStockForzado ? "Quitar \"Sin stock\"" : "Forzar \"Sin stock\"")
                    </button>
                }
            </div>
        </article>
    }
</div>

@if (TempData["OkMsg"] != null)
{<div class="alert alert-success">@TempData["OkMsg"]</div>}
@if (TempData["ErrMsg"] != null)
{<div class="alert alert-danger">@TempData["ErrMsg"]</div>}

<style>
    .cards {
        display: grid;
        grid-template-columns: repeat(auto-fill,minmax(240px,1fr));
        gap: 18px
    }

    .card {
        border: 1px solid #e6e6e6;
        border-radius: 10px;
        overflow: hidden;
        background: #fff;
        padding-bottom: 8px
    }

    .img-wrap {
        height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fafafa
    }

        .img-wrap img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain
        }

    .card h4 {
        margin: 10px 12px 0;
        font-weight: 700
    }

    .card .meta {
        margin: 6px 12px 6px;
        color: #666;
        display: flex;
        justify-content: space-between
    }

    .card .actions {
        padding: 8px 12px 0;
        display: flex;
        gap: 8px;
        flex-wrap: wrap
    }

    .admin-actions {
        padding: 8px 12px 0
    }

    .inline {
        display: inline-block;
    }

    .badges {
        margin: 0 12px 6px;
        display: flex;
        gap: 6px;
        flex-wrap: wrap
    }

    .badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 12px
    }

    .badge-danger {
        background: #f2dede;
        color: #a94442
    }

    .badge-warning {
        background: #fcf8e3;
        color: #8a6d3b
    }

    .badge-ok {
        background: #e8f5e9;
        color: #2e7d32
    }

    .badge-muted {
        background: #eee;
        color: #666
    }

    .repuestos-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin: 0 0 16px 0;
    }

    .repuestos-search {
        display: flex;
        gap: 8px;
        align-items: center;
        width: 100%;
        max-width: 420px;
        margin-left: auto;
    }
</style>

<script>
    (function () {
        var btn = document.getElementById('searchBtn');
        var search = document.getElementById('searchText');
        var cards = document.getElementById('cards');

        function filtrar() {
            var q = (search.value || '').toLowerCase();
            var items = cards.querySelectorAll('.card');
            items.forEach(function (el) {
                var nombre = (el.getAttribute('data-nombre') || '').toLowerCase();
                var marca = (el.getAttribute('data-marca') || '').toLowerCase();
                el.style.display = (nombre.indexOf(q) >= 0 || marca.indexOf(q) >= 0) ? '' : 'none';
            });
        }

        if (btn) btn.addEventListener('click', function (e) { e.preventDefault(); filtrar(); });
        if (search) search.addEventListener('keyup', function (e) { if (e.key === 'Enter') filtrar(); });
    })();
</script>
